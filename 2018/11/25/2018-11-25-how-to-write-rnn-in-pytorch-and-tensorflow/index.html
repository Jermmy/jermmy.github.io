<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



  
  
  <link rel="stylesheet" media="all" href="/lib/Han/dist/han.min.css?v=3.3">




<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="æ·±åº¦å­¦ä¹ ,pytorch,tensorflow,nlp,rnn," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="æ›¾ç»ï¼Œä¸ºäº†å¤„ç†ä¸€äº›åºåˆ—ç›¸å…³çš„æ•°æ®ï¼Œæˆ‘ç¨å¾®äº†è§£äº†ä¸€ç‚¹é€’å½’ç½‘ç»œ (RNN) çš„ä¸œè¥¿ã€‚ç”±äºå½“æ—¶åªä¼š tensorflowï¼Œå°±ä»å®˜ç½‘ä¸Šæ‰¾äº†ä¸€äº› tensorflow ç›¸å…³çš„ demoï¼Œä¸­é—´é™†é™†ç»­ç»­æŠ˜è…¾äº†ä¸¤ä¸ªå¤šæ˜ŸæœŸï¼Œæ‰å¯¹ squence to sequenceï¼Œsequence classification è¿™äº›å¸¸è§çš„æ¨¡å‹å’Œä»£ç æœ‰äº†ä¸€äº›è‚¤æµ…çš„è®¤è¯†ã€‚è™½ç„¶åªæ˜¯å¤šäº†æ—¶é—´è¿™ä¸ªç»´åº¦ï¼Œä½† RNN ç›¸å…³çš„ä¸œè¥¿ï¼Œä¸ä»…æ˜¯æ¨¡å‹">
<meta name="keywords" content="æ·±åº¦å­¦ä¹ ,pytorch,tensorflow,nlp,rnn">
<meta property="og:type" content="article">
<meta property="og:title" content="RNNï¼Œå†™èµ·æ¥çœŸçš„çƒ¦">
<meta property="og:url" content="https://jermmy.github.io/2018/11/25/2018-11-25-how-to-write-rnn-in-pytorch-and-tensorflow/index.html">
<meta property="og:site_name" content="Jermmy&#39;s Lazy Blog">
<meta property="og:description" content="æ›¾ç»ï¼Œä¸ºäº†å¤„ç†ä¸€äº›åºåˆ—ç›¸å…³çš„æ•°æ®ï¼Œæˆ‘ç¨å¾®äº†è§£äº†ä¸€ç‚¹é€’å½’ç½‘ç»œ (RNN) çš„ä¸œè¥¿ã€‚ç”±äºå½“æ—¶åªä¼š tensorflowï¼Œå°±ä»å®˜ç½‘ä¸Šæ‰¾äº†ä¸€äº› tensorflow ç›¸å…³çš„ demoï¼Œä¸­é—´é™†é™†ç»­ç»­æŠ˜è…¾äº†ä¸¤ä¸ªå¤šæ˜ŸæœŸï¼Œæ‰å¯¹ squence to sequenceï¼Œsequence classification è¿™äº›å¸¸è§çš„æ¨¡å‹å’Œä»£ç æœ‰äº†ä¸€äº›è‚¤æµ…çš„è®¤è¯†ã€‚è™½ç„¶åªæ˜¯å¤šäº†æ—¶é—´è¿™ä¸ªç»´åº¦ï¼Œä½† RNN ç›¸å…³çš„ä¸œè¥¿ï¼Œä¸ä»…æ˜¯æ¨¡å‹">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://jermmy.github.io/images/2018-11-25/rnn.png">
<meta property="og:image" content="https://jermmy.github.io/images/2018-11-25/rnn.gif">
<meta property="og:updated_time" content="2019-07-01T08:53:33.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RNNï¼Œå†™èµ·æ¥çœŸçš„çƒ¦">
<meta name="twitter:description" content="æ›¾ç»ï¼Œä¸ºäº†å¤„ç†ä¸€äº›åºåˆ—ç›¸å…³çš„æ•°æ®ï¼Œæˆ‘ç¨å¾®äº†è§£äº†ä¸€ç‚¹é€’å½’ç½‘ç»œ (RNN) çš„ä¸œè¥¿ã€‚ç”±äºå½“æ—¶åªä¼š tensorflowï¼Œå°±ä»å®˜ç½‘ä¸Šæ‰¾äº†ä¸€äº› tensorflow ç›¸å…³çš„ demoï¼Œä¸­é—´é™†é™†ç»­ç»­æŠ˜è…¾äº†ä¸¤ä¸ªå¤šæ˜ŸæœŸï¼Œæ‰å¯¹ squence to sequenceï¼Œsequence classification è¿™äº›å¸¸è§çš„æ¨¡å‹å’Œä»£ç æœ‰äº†ä¸€äº›è‚¤æµ…çš„è®¤è¯†ã€‚è™½ç„¶åªæ˜¯å¤šäº†æ—¶é—´è¿™ä¸ªç»´åº¦ï¼Œä½† RNN ç›¸å…³çš„ä¸œè¥¿ï¼Œä¸ä»…æ˜¯æ¨¡å‹">
<meta name="twitter:image" content="https://jermmy.github.io/images/2018-11-25/rnn.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"hide","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://jermmy.github.io/2018/11/25/2018-11-25-how-to-write-rnn-in-pytorch-and-tensorflow/"/>





  <title>RNNï¼Œå†™èµ·æ¥çœŸçš„çƒ¦ | Jermmy's Lazy Blog</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-84659849-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?4d053879042f439aeb8fc5996a907b6b";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jermmy's Lazy Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            æ ‡ç­¾
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://jermmy.github.io/2018/11/25/2018-11-25-how-to-write-rnn-in-pytorch-and-tensorflow/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jermmy">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jermmy's Lazy Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                RNNï¼Œå†™èµ·æ¥çœŸçš„çƒ¦
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-11-25T17:49:42+08:00">
                2018-11-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/NLP/" itemprop="url" rel="index">
                    <span itemprop="name">NLP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/25/2018-11-25-how-to-write-rnn-in-pytorch-and-tensorflow/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/11/25/2018-11-25-how-to-write-rnn-in-pytorch-and-tensorflow/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/11/25/2018-11-25-how-to-write-rnn-in-pytorch-and-tensorflow/" class="leancloud_visitors" data-flag-title="RNNï¼Œå†™èµ·æ¥çœŸçš„çƒ¦">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•° </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        <p>æ›¾ç»ï¼Œä¸ºäº†å¤„ç†ä¸€äº›åºåˆ—ç›¸å…³çš„æ•°æ®ï¼Œæˆ‘ç¨å¾®äº†è§£äº†ä¸€ç‚¹é€’å½’ç½‘ç»œ (RNN) çš„ä¸œè¥¿ã€‚ç”±äºå½“æ—¶åªä¼š tensorflowï¼Œå°±ä»å®˜ç½‘ä¸Šæ‰¾äº†ä¸€äº› tensorflow ç›¸å…³çš„ demoï¼Œä¸­é—´é™†é™†ç»­ç»­æŠ˜è…¾äº†ä¸¤ä¸ªå¤šæ˜ŸæœŸï¼Œæ‰å¯¹ squence to sequenceï¼Œsequence classification è¿™äº›å¸¸è§çš„æ¨¡å‹å’Œä»£ç æœ‰äº†ä¸€äº›è‚¤æµ…çš„è®¤è¯†ã€‚è™½ç„¶åªæ˜¯å¤šäº†<strong>æ—¶é—´</strong>è¿™ä¸ªç»´åº¦ï¼Œä½† RNN ç›¸å…³çš„ä¸œè¥¿ï¼Œä¸ä»…æ˜¯æ¨¡å‹æ­å»ºä¸Šï¼Œåœ¨æ•°æ®å¤„ç†æ–¹é¢çš„ç¹çç¨‹åº¦ä¹Ÿæ¯” CNN è¦é«˜ä¸€ä¸ª levelã€‚å¦å¤–ï¼Œæˆ‘ä¹Ÿæ˜¯ä»é‚£ä¸ªæ—¶å€™å¼€å§‹å¯¹ tensorflow äº§ç”ŸæŠµè§¦å¿ƒç†ï¼Œåœ¨ tf ä¸­ï¼Œä½ çŸ¥é“ RNN æœ‰å‡ ç§å†™æ³•å—ï¼Ÿä½ çŸ¥é“ dynamic_rnn å’Œ static_rnn æœ‰ä»€ä¹ˆåŒºåˆ«å—ï¼Ÿå„ç§çº·ç¹å¤æ‚çš„æ¦‚å¿µæ— ç–‘åŠ å¤§äº†åˆå­¦è€…çš„é—¨æ§›ã€‚åæ¥æˆ‘èŠ±äº†ä¸€ä¸¤å¤©çš„æ—¶é—´è½¬å‘ pytorch åï¼Œæ„Ÿè§‰æ•´ä¸ªä¸–ç•Œç¬é—´æ¸…å‡€äº† (å½“ç„¶äº†ï¼Œå­¦ tf çš„å¥½å¤„å°±æ˜¯è½¬å…¶ä»–æ¡†æ¶çš„æ—¶å€™éå¸¸å¿«ï¼Œä½†ä»å…¶ä»–æ¡†æ¶è½¬ tf å´å¯èƒ½ç”Ÿä¸å¦‚æ­»)ã€‚pytorch åœ¨æ¨¡å‹æ­å»ºå’Œæ•°æ®å¤„ç†æ–¹é¢éƒ½éå¸¸å¥½ä¸Šæ‰‹ï¼Œæ¯”èµ· tf è€Œè¨€ï¼Œä»£ç å†™èµ·æ¥æ›´åŠ æ•´æ´å¹²å‡€ï¼Œè€Œä¸”å¼€å‘äººå‘˜æ›´å®¹æ˜“ç†è§£ä»£ç çš„è¿ä½œæµç¨‹ã€‚ä¸è¿‡ï¼Œåœ¨ RNN è¿™ä¸ªé—®é¢˜ä¸Šï¼Œæ–°æ‰‹è¿˜æ˜¯å®¹æ˜“çŠ¯å˜€å’•ã€‚è¶ç€è¿™ä¸€å‘¨åˆšåˆšæ‘¸æ¸…äº† pytorch æ­å»º RNN çš„å¥—è·¯ï¼Œæˆ‘å‡†å¤‡è®°å½•ä¸€ä¸‹ç”¨ pytorch æ­å»º RNN çš„åŸºæœ¬æµç¨‹ï¼Œä»¥åŠæ•°æ®å¤„ç†æ–¹é¢è¦æ³¨æ„çš„é—®é¢˜ï¼Œå¸Œæœ›åæ¥çš„åŒå­¦ä»¬å°‘æµç‚¹è¡€æ³ªâ€¦</p>
<p>è‡³äº tf æ€ä¹ˆå†™ RNNï¼Œä¹‹åæœ‰é—²å†è¡¥ä¸Š (æˆ‘ç°åœ¨æ˜¯çœŸçš„ä¸æƒ³å›å»ç¢°é‚£é¢—çƒ«æ‰‹çš„å±±èŠ‹ğŸ˜©)</p>
<center>
<img src="/images/2018-11-25/rnn.png">
</center>
<a id="more"></a>
<h2 id="ä»€ä¹ˆæ˜¯-rnn">ä»€ä¹ˆæ˜¯ RNN</h2>
<p>è™½ç„¶è¯´æˆ‘ä»¬ç”¨çš„æ˜¯ APIï¼Œä½†å¯¹äº RNN æ˜¯ä»€ä¹ˆä¸œè¥¿è¿˜æ˜¯å¾—äº†è§£ä¸€ä¸‹å§ã€‚å¯¹äºä»æ²¡æ¥è§¦è¿‡ RNN çš„å°ç™½æ¥è¯´ï¼Œkarpathy è¿™ç¯‡å®¶å–»æˆ·æ™“çš„<a href="https://karpathy.github.io/2015/05/21/rnn-effectiveness/" target="_blank" rel="noopener">æ–‡ç« </a>æ˜¯ä¸€å®šè¦è¯»ä¸€ä¸‹çš„ï¼Œå¦‚æœæƒ³æ›´åŠ å½¢è±¡åœ°äº†è§£å®ƒçš„å·¥ä½œæœºåˆ¶ï¼Œå¯ä»¥æœä¸€äº›<strong>æå®æ¯…</strong>çš„æ·±åº¦å­¦ä¹ æ•™ç¨‹ã€‚</p>
<p>RNN å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªæ™®é€šçš„ç¥ç»ç½‘ç»œï¼Œåªä¸è¿‡å¤šäº†ä¸€ä¸ª hidden state æ¥ä¿å­˜å†å²ä¿¡æ¯ã€‚è·Ÿä¸€èˆ¬ç½‘ç»œä¸åŒçš„æ˜¯ï¼ŒRNN ç½‘ç»œçš„è¾“å…¥æ•°æ®çš„ç»´åº¦é€šå¸¸æ˜¯ <span class="math inline">\([batch\_size \times seq\_len \times input\_size ]\)</span>ï¼Œå®ƒå¤šäº†ä¸€ä¸ªåºåˆ—é•¿åº¦ <span class="math inline">\(seq\_len\)</span>ã€‚åœ¨å‰å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šæŠŠæ ·æœ¬ <span class="math inline">\(t\)</span> ä¸ªæ—¶é—´åºåˆ—çš„ä¿¡æ¯ä¸æ–­è¾“å…¥åŒä¸€ä¸ªç½‘ç»œ (è§ä¸Šå›¾)ï¼Œå› ä¸ºæ˜¯é‡å¤åœ°ä½¿ç”¨åŒä¸€ä¸ªç½‘ç»œï¼Œæ‰€ä»¥ç§°ä¸ºé€’å½’ç½‘ç»œã€‚</p>
<p>å…³äº RNNï¼Œä½ åªéœ€è¦è®°ä½ä¸€ä¸ªå…¬å¼ï¼š<span class="math inline">\(h_t = \tanh(w_{ih} x_t + b_{ih} + w_{hh} h_{(t-1)} + b_{hh})\)</span>ã€‚è¿™ä¹Ÿæ˜¯ pytorch å®˜æ–¹æ–‡æ¡£ä¸­ç»™å‡ºçš„æœ€åŸå§‹çš„ RNN å…¬å¼ï¼Œå…¶ä¸­ <span class="math inline">\(w_{*}\)</span> è¡¨ç¤º weightï¼Œ<span class="math inline">\(b_{*}\)</span> è¡¨ç¤º biasï¼Œ<span class="math inline">\(x_t\)</span> æ˜¯è¾“å…¥ï¼Œ<span class="math inline">\(h_t\)</span> æ˜¯éšè—çŠ¶æ€ã€‚å›å¿†ä¸€ä¸‹ï¼Œæ™®é€šçš„ç¥ç»ç½‘ç»œåªæœ‰ <span class="math inline">\(w_{ih} x_t + b_{ih}\)</span> è¿™ä¸€éƒ¨åˆ†ï¼Œè€Œ RNN æ— éå°±æ˜¯å¤šåŠ äº†ä¸€ä¸ªéšè—çŠ¶æ€çš„ä¿¡æ¯ <span class="math inline">\(w_{hh} h_{(t-1)} + b_{hh}\)</span> è€Œå·²ã€‚</p>
<p>æ™®é€šç½‘ç»œéƒ½æ˜¯ä¸€æ¬¡å‰å‘ä¼ æ’­å°±å¾—åˆ°ç»“æœï¼Œè€Œ RNN å› ä¸ºå¤šäº† sequence è¿™ä¸ªç»´åº¦ï¼Œæ‰€ä»¥éœ€è¦è·‘ n æ¬¡å‰å‘ã€‚æˆ‘ä»¬ç”¨ numpy çš„å†™æ³•æŠŠ RNN çš„å·¥ä½œæµç¨‹æ€»ç»“ä¸€ä¸‹ï¼Œå°±å¾—åˆ°äº†å¦‚ä¸‹ä»£ç  (éƒ¨åˆ†æŠ„è‡ª <strong>karpathy</strong> çš„æ–‡ç« )ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿™é‡Œè¦å•°å—¦ä¸€å¥ï¼Œkarpathyåœ¨RNNçš„å‰å‘ä¸­è¿˜è®¡ç®—äº†ä¸€ä¸ªè¾“å‡ºå‘é‡output vectorï¼Œ</span></span><br><span class="line"><span class="comment"># ä½†æ ¹æ®RNNçš„åŸå§‹å…¬å¼ï¼Œå®ƒçš„è¾“å‡ºåªæœ‰ä¸€ä¸ªhidden stateï¼Œè‡³äºæ•´ä¸ªç½‘ç»œæœ€åçš„output vectorï¼Œ</span></span><br><span class="line"><span class="comment"># æ˜¯åœ¨hidden stateä¹‹åå†æ¥ä¸€ä¸ªå…¨è¿æ¥å±‚å¾—åˆ°çš„ï¼Œæ‰€ä»¥å¹¶ä¸å±äºRNNçš„å†…å®¹ã€‚</span></span><br><span class="line"><span class="comment"># åŒ…æ‹¬pytorchå’Œtfæ¡†æ¶ä¸­ï¼ŒRNNçš„è¾“å‡ºä¹Ÿåªæœ‰hidden stateã€‚ç†è§£è¿™ä¸€ç‚¹å¾ˆé‡è¦ã€‚</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RNN</span>:</span></span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">step</span><span class="params">(self, x, hidden)</span>:</span></span><br><span class="line">    <span class="comment"># update the hidden state</span></span><br><span class="line">    hidden = np.tanh(np.dot(self.W_hh, hidden) + np.dot(self.W_xh, x))</span><br><span class="line">    <span class="keyword">return</span> hidden</span><br><span class="line"></span><br><span class="line">rnn = RNN()</span><br><span class="line"><span class="comment"># x: [batch_size * seq_len * input_size]</span></span><br><span class="line">x = get_data()</span><br><span class="line">seq_len = x.shape[<span class="number">1</span>]</span><br><span class="line"><span class="comment"># åˆå§‹åŒ–ä¸€ä¸ªhidden stateï¼ŒRNNä¸­çš„å‚æ•°æ²¡æœ‰åŒ…æ‹¬hidden stateï¼Œ</span></span><br><span class="line"><span class="comment"># åªåŒ…æ‹¬hidden stateå¯¹åº”çš„æƒé‡Wå’Œbï¼Œ</span></span><br><span class="line"><span class="comment"># æ‰€ä»¥ä¸€èˆ¬æˆ‘ä»¬ä¼šæ‰‹åŠ¨åˆå§‹åŒ–ä¸€ä¸ªå…¨é›¶çš„hidden state</span></span><br><span class="line">hidden_state = np.zeros()</span><br><span class="line"><span class="comment"># ä¸‹é¢è¿™ä¸ªå¾ªç¯å°±æ˜¯RNNçš„å·¥ä½œæµç¨‹äº†ï¼Œçœ‹åˆ°æ²¡æœ‰ï¼Œæ¯æ¬¡è¾“å…¥çš„éƒ½æ˜¯ä¸€ä¸ªæ—¶é—´æ­¥é•¿çš„æ•°æ®ï¼Œ</span></span><br><span class="line"><span class="comment"># ç„¶ååŒä¸€ä¸ªhidden_stateä¼šåœ¨å¾ªç¯ä¸­åå¤è¾“å…¥åˆ°ç½‘ç»œä¸­ã€‚</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(seq_len):</span><br><span class="line">    hidden_state = rnn(x[:, i, :], hidden_state)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¿‡æ¥äººè¡€æ³ªæ•™è®­ï¼šä¸€å®šè¦çœ‹æ‡‚ä¸Šé¢çš„ä»£ç å†å¾€ä¸‹è¯»å‘€ã€‚</p>
</blockquote>
<h2 id="pytorch-ä¸­çš„-rnn">pytorch ä¸­çš„ RNN</h2>
<p>å¥½äº†ï¼Œç°åœ¨å¯ä»¥è¿›å…¥æœ¬æ–‡æ­£é¢˜äº†ã€‚æˆ‘ä»¬åˆ†<strong>æ•°æ®å¤„ç†</strong>å’Œ<strong>æ¨¡å‹æ­å»º</strong>ä¸¤éƒ¨åˆ†æ¥ä»‹ç»ã€‚</p>
<h3 id="æ•°æ®å¤„ç†">æ•°æ®å¤„ç†</h3>
<p>pytorch çš„æ•°æ®è¯»å–æ¡†æ¶æ–¹ä¾¿æ˜“ç”¨ï¼Œæ¯” tf çš„ <a href="https://www.tensorflow.org/guide/datasets?hl=zh-cn" target="_blank" rel="noopener">Dataset</a> æ›´æœ‰äº²å’ŒåŠ›ã€‚å¦å¤–ï¼Œtf çš„æ•°æ®é˜Ÿåˆ—åº•å±‚æ˜¯ç”¨ C++ çš„å¤šçº¿ç¨‹å®ç°çš„ï¼Œå› æ­¤æ•°æ®è¯»å–å’Œé¢„å¤„ç†éƒ½è¦ä½¿ç”¨ tf å†…éƒ¨æä¾›çš„ APIï¼Œå¦åˆ™å°±å¤±å»å¤šçº¿ç¨‹çš„èƒ½åŠ›ï¼Œè¿™ä¸€ç‚¹å®åœ¨æ˜¯ä»¤äººè„‘å£³ç–¼ã€‚å†è€…ï¼Œè¿‡æ¥äººè¡€æ³ªæ•™è®­ï¼Œtf 1.4 ç‰ˆæœ¬çš„ Dataset api æœ‰çº¿ç¨‹æ­»é”çš„<a href="https://github.com/tensorflow/tensorflow/issues/10369" target="_blank" rel="noopener">bug</a>ï¼Œè°ç”¨è°çŸ¥é“ğŸ˜ˆã€‚è€Œ pytorch åŸºäºå¤šè¿›ç¨‹çš„æ•°æ®è¯»å–æœºåˆ¶ï¼Œé¿å… python GIL çš„é—®é¢˜ï¼ŒåŒæ—¶ä»£ç ç¼–å†™ä¸Šæ›´åŠ çµæ´»ï¼Œå¯ä»¥éšæ„ä½¿ç”¨ opencvã€PIL è¿›è¡Œå¤„ç†ï¼Œçˆ½åˆ°é£èµ·ã€‚</p>
<p>pytorch çš„æ•°æ®è¯»å–é˜Ÿåˆ—ä¸»è¦é  <code>torch.utils.data.Dataset</code> å’Œ <code>torch.utils.data.DataLoader</code> å®ç°ï¼Œå…·ä½“ç”¨æ³•è¿™é‡Œç•¥è¿‡ï¼Œä¸»è¦è®²ä¸€ä¸‹åœ¨ RNN æ¨¡å‹ä¸­ï¼Œæ•°æ®å¤„ç†æœ‰å“ªäº›éœ€è¦æ³¨æ„çš„åœ°æ–¹ã€‚</p>
<p>åœ¨ä¸€èˆ¬çš„æ•°æ®è¯»å–ä»»åŠ¡ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ <code>Dataset</code> çš„ <code>__getitem__</code> æ–¹æ³•ä¸­è¿”å›ä¸€ä¸ªæ ·æœ¬å³å¯ï¼Œpytorch ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬æŠŠä¸€ä¸ª batch çš„æ ·æœ¬ç»„è£…èµ·æ¥ï¼Œå› æ­¤ï¼Œåœ¨ RNN ç›¸å…³çš„ä»»åŠ¡ä¸­ï¼Œ<code>__getitem__</code> é€šå¸¸è¿”å›çš„æ˜¯ä¸€ä¸ªç»´åº¦ä¸º <span class="math inline">\([seq\_len \times input\_size]\)</span> çš„æ•°æ®ã€‚è¿™æ—¶ï¼Œæˆ‘ä»¬ä¼šé‡åˆ°ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯ä¸åŒæ ·æœ¬çš„ <span class="math inline">\(seq\_len\)</span> æ˜¯å¦ç›¸åŒã€‚å¦‚æœç›¸åŒçš„è¯ï¼Œé‚£ä¹‹åå°±çœäº‹å¤ªå¤šäº†ï¼Œä½†å¦‚æœä¸åŒï¼Œè¿™ä¸ªåœ°æ–¹å°±ä¼šæˆä¸ºåˆå­¦è€…ç¬¬ä¸€é“åã€‚å› æ­¤ï¼Œä¸‹é¢å°±é’ˆå¯¹ <span class="math inline">\(seq\_len\)</span> ä¸åŒçš„æƒ…å†µä»‹ç»ä¸€ä¸‹é€šç”¨çš„å¤„ç†æ–¹æ³•ã€‚</p>
<p>é¦–å…ˆéœ€è¦æ˜ç¡®çš„æ˜¯ï¼Œå¦‚æœ <span class="math inline">\(seq\_len\)</span> ä¸åŒï¼Œé‚£ä¹ˆ pytorch åœ¨ç»„è£… batch çš„æ—¶å€™ä¼šé¦–å…ˆæŠ¥é”™ï¼Œå› ä¸ºä¸€ä¸ª batch å¿…é¡»æ˜¯ä¸€ä¸ª n-dimensional çš„ tensorï¼Œ<span class="math inline">\(seq\_len\)</span> ä¸åŒçš„è¯ï¼Œè¯æ˜æœ‰ä¸€ä¸ªç»´åº¦çš„é•¿åº¦æ˜¯ä¸å›ºå®šçš„ï¼Œé‚£å°±æ²¡æ³•ç»„è£…æˆä¸€ä¸ªæ–¹æ–¹æ­£æ­£çš„ tensor äº†ã€‚å› æ­¤ï¼Œåœ¨æ•°æ®é¢„å¤„ç†æ—¶ï¼Œéœ€è¦è®°å½•ä¸‹æ¯ä¸ªæ ·æœ¬çš„ <span class="math inline">\(seq\_len\)</span>ï¼Œç„¶åç»Ÿè®¡å‡ºä¸€ä¸ªå‡å€¼æˆ–è€…æœ€å¤§å€¼ï¼Œä¹‹åï¼Œæ¯æ¬¡å–æ•°æ®çš„æ—¶å€™ï¼Œéƒ½å¿…é¡»æŠŠæ•°æ®çš„ <span class="math inline">\(seq\_len\)</span> å¡«å…… (è¡¥0) æˆ–è€…è£å‰ªåˆ°è¿™ä¸ªå›ºå®šçš„é•¿åº¦ï¼Œè€Œä¸”è¦è®°å¾—æŠŠè¯¥æ ·æœ¬çœŸå®çš„ <span class="math inline">\(seq\_len\)</span> ä¹Ÿä¸€èµ·å–å‡ºæ¥ (åé¢æœ‰å¤§ç”¨)ã€‚ä¾‹å¦‚ä¸‹é¢çš„ä»£ç ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, idx)</span>:</span></span><br><span class="line">    <span class="comment"># data: seq_len * input_size</span></span><br><span class="line">    data, label, seq_len = self.train_data[idx]</span><br><span class="line">    <span class="comment"># pad_data: max_seq_len * input_size</span></span><br><span class="line">    pad_data = np.zeros(shape=(self.max_seq_len, data.shape[<span class="number">1</span>]))</span><br><span class="line">    pad_sketch[<span class="number">0</span>:data.shape[<span class="number">0</span>]] = data</span><br><span class="line">    sample = &#123;<span class="string">'data'</span>: pad_data, <span class="string">'label'</span>: label, <span class="string">'seq_len'</span>: seq_len&#125;</span><br><span class="line">    <span class="keyword">return</span> sample</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·ï¼Œä½ ä»å¤–éƒ¨æ‹¿åˆ°çš„ batch æ•°æ®å°±æ˜¯ä¸€ä¸ª <span class="math inline">\([batch\_size \times max\_seq\_len \times input\_size]\)</span> çš„ tensorã€‚</p>
<h3 id="æ¨¡å‹æ­å»º">æ¨¡å‹æ­å»º</h3>
<h4 id="rnn">RNN</h4>
<p>æ‹¿åˆ°æ•°æ®åï¼Œä¸‹é¢å°±è¦æ­£å¼ç”¨ pytorch çš„ RNN äº†ã€‚ä»æˆ‘æœ€å¼€å§‹å†™çš„é‚£æ®µ RNN çš„ä»£ç ä¹Ÿèƒ½çœ‹å‡ºï¼ŒRNN å…¶å®å°±æ˜¯åœ¨ä¸€ä¸ªå¾ªç¯ä¸­ä¸æ–­çš„ forward è€Œå·²ã€‚ä½†ç›´æ¥å¾ªç¯è°ƒç”¨å…¶å®æ˜¯éå¸¸ä½æ•ˆçš„ï¼Œpytoch å†…éƒ¨ä¼šç”¨ CUDA çš„å‡½æ•°æ¥åŠ é€Ÿè¿™é‡Œçš„æ“ä½œï¼Œå¯¹äºç›´æ¥è°ƒ API çš„æˆ‘ä»¬æ¥è¯´ï¼Œåªéœ€è¦çŸ¥é“ <code>RNN</code> è¿”å›ç»™æˆ‘ä»¬çš„æ˜¯ä»€ä¹ˆå³å¯ã€‚è®©æˆ‘ä»¬ç¿»å¼€<a href="https://pytorch.org/docs/stable/nn.html#torch.nn.RNN" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a>ï¼š</p>
<blockquote>
<p>class torch.nn.RNN(*args, **kwargs)</p>
<p>Parameters: <strong>input_size</strong>, <strong>hidden_size</strong>, <strong>num_layers</strong>, â€¦</p>
<p>Inputs: input, h_0</p>
<ul>
<li><strong>input</strong> of shape (seq_len, batch, input_size)</li>
<li><strong>h_0</strong> of shape (num_layers * num_directions, batch, hidden_size)</li>
</ul>
<p>Outputs: output, h_n</p>
<ul>
<li><strong>output</strong> of shape (seq_len, batch, num_directions * hidden_size)</li>
<li><strong>h_n</strong> (num_layers * num_directions, batch, hidden_size)</li>
</ul>
</blockquote>
<p>è¿™é‡Œæˆ‘åªæ‘˜å½•åˆå§‹åŒ–å‚æ•°ä»¥åŠè¾“å…¥è¾“å‡ºçš„ shapeï¼Œè®°ä½è¿™äº›ä¿¡æ¯å°±å¤Ÿäº†ï¼Œä¸‹é¢ä¼šè®²å…·ä½“æ€ä¹ˆç”¨ã€‚æ³¨æ„ï¼Œshape é‡Œé¢æœ‰ä¸€ä¸ª <code>num_directions</code>ï¼Œè¿™ç©æ„è¡¨ç¤ºè¿™ä¸ª RNN æ˜¯å•å‘è¿˜æ˜¯åŒå‘çš„ï¼Œç®€å•èµ·è§ï¼Œæˆ‘ä»¬è¿™é‡Œé»˜è®¤éƒ½æ˜¯å•å‘çš„ (å³<code>num_directions=1</code>)ã€‚</p>
<p>ç°åœ¨å€Ÿç”¨è¿™ç¯‡<a href="https://www.cnblogs.com/lindaxin/p/8052043.html" target="_blank" rel="noopener">æ–‡ç« </a>ä¸­çš„ä¾‹å­åšè®²è§£ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬åˆå§‹åŒ–ä¸€ä¸ª<code>RNN</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">batch_size = <span class="number">2</span></span><br><span class="line">max_length = <span class="number">3</span></span><br><span class="line">hidden_size = <span class="number">2</span></span><br><span class="line">n_layers = <span class="number">1</span></span><br><span class="line"><span class="comment"># è¿™ä¸ªRNNç”±ä¸¤ä¸ªå…¨è¿æ¥å±‚ç»„æˆï¼Œå¯¹åº”çš„ä¸¤ä¸ªhidden stateçš„ç»´åº¦æ˜¯2ï¼Œè¾“å…¥å‘é‡ç»´åº¦æ˜¯1</span></span><br><span class="line">rnn = nn.RNN(<span class="number">1</span>, hidden_size, n_layers, batch_first=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure>
<p>ç„¶åï¼Œå‡è®¾æˆ‘ä»¬çš„è¾“å…¥æ•°æ®æ˜¯è¿™æ ·å­çš„ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">x = torch.FloatTensor([[<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>], [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]]).resize_(<span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>)</span><br><span class="line">x = Variable(x)  <span class="comment"># [batch, seq, feature], [2, 3, 1]</span></span><br><span class="line">seq_lengths = np.array([<span class="number">1</span>, <span class="number">3</span>])  <span class="comment"># list of integers holding information about the batch size at each sequence step</span></span><br><span class="line">print(x)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>tensor([[[ <span class="number">1.</span>],</span><br><span class="line">         [ <span class="number">0.</span>],</span><br><span class="line">         [ <span class="number">0.</span>]],</span><br><span class="line"></span><br><span class="line">        [[ <span class="number">1.</span>],</span><br><span class="line">         [ <span class="number">2.</span>],</span><br><span class="line">         [ <span class="number">3.</span>]]])</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°è¾“å…¥æ•°æ®çš„ç»´åº¦æ˜¯ <span class="math inline">\([2 \times 3 \times 1]\)</span>ï¼Œä¹Ÿå°±æ˜¯ <span class="math inline">\(batch\_size=2\)</span>ï¼Œ<span class="math inline">\(seq\_len=3\)</span>ï¼Œ<span class="math inline">\(input\_size=1\)</span>ã€‚ä½†è¦æ³¨æ„ä¸€ç‚¹ï¼Œç¬¬ä¸€ä¸ªæ ·æœ¬çš„ <span class="math inline">\(seq\_len\)</span> çš„æœ‰æ•ˆé•¿åº¦å…¶å®æ˜¯ 1ï¼Œåé¢ä¸¤ä½éƒ½è¡¥äº† 0ã€‚é‚£ä¹ˆï¼Œåœ¨å®é™…è®¡ç®—çš„æ—¶å€™ï¼Œç¬¬ä¸€ä¸ªæ ·æœ¬å…¶å®åªè¦è·‘ 1 é forward å³å¯ï¼Œè€Œç¬¬äºŒä¸ªæ ·æœ¬æ‰éœ€è¦è·‘ 3 é forwardã€‚</p>
<h4 id="pack_padded_sequence">pack_padded_sequence</h4>
<p>é‚£å¦‚ä½•è®©<code>RNN</code>çŸ¥é“ä¸åŒæ ·æœ¬çš„åºåˆ—é•¿åº¦ä¸ä¸€æ ·å‘¢ï¼Ÿå¹¸è¿çš„æ˜¯ï¼Œpytorch å·²ç»æä¾›äº†å¾ˆå¥½çš„æ¥å£æ¥å¤„ç†è¿™ç§æƒ…å†µäº†ã€‚å¦‚æœè¾“å…¥æ ·æœ¬çš„ <span class="math inline">\(seq\_len\)</span> é•¿åº¦ä¸ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦æŠŠè¾“å…¥çš„æ¯ä¸ªæ ·æœ¬é‡æ–°æ‰“åŒ… (pack)ã€‚å…·ä½“æ¥è®²ï¼Œpytorch æä¾›äº† <code>torch.nn.utils.rnn.pack_padded_sequence</code> æ¥å£ï¼Œå®ƒä¼šå¸®æˆ‘ä»¬æŠŠè¾“å…¥è½¬ä¸ºä¸€ä¸ª <code>PackedSequence</code> å¯¹è±¡ï¼Œè€Œåè€…å°±åŒ…å«äº†æ¯ä¸ªæ ·æœ¬çš„ <span class="math inline">\(seq\_len\)</span> ä¿¡æ¯ã€‚<code>pack_padded_sequence</code>æœ€ä¸»è¦çš„è¾“å…¥æ˜¯è¾“å…¥æ•°æ®ä»¥åŠæ¯ä¸ªæ ·æœ¬çš„ <span class="math inline">\(seq\_len\)</span> ç»„æˆçš„ listã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬å¿…é¡»æŠŠè¾“å…¥æ•°æ®æŒ‰ç…§ <span class="math inline">\(seq\_len\)</span> ä»å¤§åˆ°å°æ’åˆ—åæ‰èƒ½é€å…¥ <code>pack_padded_sequence</code>ã€‚æˆ‘ä»¬ç»§ç»­ä¹‹å‰çš„ä¾‹å­ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯¹seq_lenè¿›è¡Œæ’åº</span></span><br><span class="line">order_idx = np.argsort(seq_lengths)[::<span class="number">-1</span>]</span><br><span class="line">print(<span class="string">'order_idx:'</span>, str(order_idx))</span><br><span class="line">order_x = x[order_idx.tolist()]</span><br><span class="line">order_seq = seq_lengths[order_idx]</span><br><span class="line">print(order_x)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>order_idx: [<span class="number">1</span> <span class="number">0</span>]</span><br><span class="line">    tensor([[[ <span class="number">1.</span>],</span><br><span class="line">         [ <span class="number">2.</span>],</span><br><span class="line">         [ <span class="number">3.</span>]],</span><br><span class="line"></span><br><span class="line">        [[ <span class="number">1.</span>],</span><br><span class="line">         [ <span class="number">0.</span>],</span><br><span class="line">         [ <span class="number">0.</span>]]])</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»è¿‡ä»¥ä¸Šå¤„ç†åï¼Œé•¿åºåˆ—çš„æ ·æœ¬è°ƒæ•´åˆ°çŸ­åºåˆ—æ ·æœ¬ä¹‹å‰äº†</span></span><br><span class="line"><span class="comment"># pack it</span></span><br><span class="line">pack = pack_padded_sequence(order_x, order_seq, batch_first=<span class="keyword">True</span>)</span><br><span class="line">print(pack)</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt;PackedSequence(data=tensor([[ <span class="number">1.</span>],</span><br><span class="line">        [ <span class="number">1.</span>],</span><br><span class="line">        [ <span class="number">2.</span>],</span><br><span class="line">        [ <span class="number">3.</span>]]), batch_sizes=tensor([ <span class="number">2</span>,  <span class="number">1</span>,  <span class="number">1</span>]))</span><br></pre></td></tr></table></figure>
<p>ç†è§£è¿™é‡Œçš„ <code>PackedSequence</code> æ˜¯å…³é”®ã€‚</p>
<p>å‰é¢è¯´åˆ°ï¼Œ<code>RNN</code> å…¶å®å°±æ˜¯åœ¨å¾ªç¯åœ° forwardã€‚åœ¨ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œå®ƒæ¯æ¬¡ forward çš„æ•°æ®æ˜¯è¿™æ ·çš„ï¼š</p>
<center>
<img src="/images/2018-11-25/rnn.gif" width="300px">
</center>
<p>ç¬¬ä¸€ä¸ªåºåˆ—ä¸­ï¼Œç”±äºä¸¤ä¸ªæ ·æœ¬éƒ½æœ‰æ•°æ®ï¼Œæ‰€ä»¥å¯ä»¥çœ‹ä½œæ˜¯ <span class="math inline">\(batch\_size=2\)</span> çš„è¾“å…¥ï¼Œåé¢ä¸¤ä¸ªåºåˆ—åªæœ‰ç¬¬ä¸€ä¸ªæ ·æœ¬æœ‰æ•°æ®ï¼Œæ‰€ä»¥å¯ä»¥çœ‹ä½œæ˜¯ <span class="math inline">\(batch\_size=1\)</span> çš„è¾“å…¥ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å…¶å®å¯ä»¥æŠŠè¿™ä¸‰ä¸ªåºåˆ—çš„æ•°æ®åˆ†è§£ä¸ºä¸‰ä¸ª batch æ ·æœ¬ï¼Œåªä¸è¿‡ batch çš„å¤§å°åˆ†åˆ«ä¸º 2ï¼Œ1ï¼Œ1ã€‚åˆ°è¿™é‡Œä½ åº”è¯¥æ¸…æ¥š <code>PackedSequence</code> é‡Œçš„ <code>data</code> å’Œ <code>batch_size</code> æ˜¯ä»€ä¹ˆä¸œè¥¿äº†å§ï¼Œå…¶å®å°±æ˜¯æŠŠæˆ‘ä»¬çš„è¾“å…¥æ•°æ®é‡æ–°æ•´ç†æ‰“åŒ…æˆ <code>data</code>ï¼ŒåŒæ—¶æ ¹æ®æˆ‘ä»¬ä¼ å…¥çš„ seq list è®¡ç®— <code>batch_size</code>ï¼Œç„¶åï¼Œ<code>RNN</code> ä¼šæ ¹æ® <code>batch_size</code> ä»æ‰“åŒ…å¥½çš„ <code>data</code> é‡Œé¢å–æ•°æ®ï¼Œç„¶åä¸€ééçš„æ‰§è¡Œ forward å‡½æ•°ã€‚</p>
<p>ç†è§£è¿™ä¸€æ­¥åï¼Œä¸»è¦éš¾ç‚¹å°±è§£å†³äº†ã€‚</p>
<h4 id="rnnçš„è¾“å‡º">RNNçš„è¾“å‡º</h4>
<p>ä»æ–‡æ¡£ä¸­å¯ä»¥çœ‹å‡ºï¼Œ<code>RNN</code> è¾“å‡ºä¸¤ä¸ªä¸œè¥¿ï¼š<code>output</code> å’Œ <code>h_n</code>ã€‚å…¶ä¸­ï¼Œ<code>h_n</code> æ˜¯è·‘å®Œæ•´ä¸ªæ—¶é—´åºåˆ—å hidden state çš„æ•°å€¼ï¼Œå…¶ä¸­ <code>num_layers</code> è¡¨ç¤ºè¿™ä¸ª RNN æœ‰å¤šå°‘å±‚ç¥ç»å…ƒï¼Œæ¯”å¦‚ï¼Œä¸€ä¸ªç”±ä¸¤å±‚ 500 ç»´çš„å…¨è¿æ¥å±‚ç»„æˆçš„ RNNï¼Œå…¶ <code>num_layers</code> å°±æ˜¯ 2ã€‚ä½† <code>output</code> åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¹‹å‰ä¸æ˜¯è¯´è¿‡åŸå§‹çš„ <code>RNN</code> åªè¾“å‡º hidden state å—ï¼Œä¸ºä»€ä¹ˆè¿™é‡Œåˆä¼šæœ‰ä¸€ä¸ª <code>output</code>ï¼Ÿå…¶å®ï¼Œè¿™ä¸ª <code>output</code> å¹¶ä¸æ˜¯æˆ‘ä»¬ç†è§£çš„ç½‘ç»œæœ€åçš„ output vectorï¼Œè€Œæ˜¯æ¯æ¬¡ forward åè®¡ç®—å¾—åˆ°çš„ hidden stateã€‚æ¯•ç«Ÿ <code>h_n</code> åªä¿ç•™äº†æœ€åä¸€æ­¥çš„ hidden stateï¼Œä½†ä¸­é—´çš„ hidden state ä¹Ÿæœ‰å¯èƒ½ä¼šå‚ä¸è®¡ç®—ï¼Œæ‰€ä»¥ pytorch æŠŠä¸­é—´æ¯ä¸€æ­¥è¾“å‡ºçš„ hidden state éƒ½æ”¾åˆ° <code>output</code> ä¸­ï¼ˆå½“ç„¶ï¼Œåªä¿ç•™äº† hidden state æœ€åä¸€å±‚çš„è¾“å‡ºï¼‰ï¼Œå› æ­¤ï¼Œä½ å¯ä»¥å‘ç°è¿™ä¸ª <code>output</code> çš„ç»´åº¦æ˜¯ <code>(seq_len, batch, num_directions * hidden_size)</code>ã€‚</p>
<p>ä¸è¿‡ï¼Œå¦‚æœä½ ä¹‹å‰ç”¨ <code>pack_padded_sequence</code> æ‰“åŒ…è¿‡æ•°æ®ï¼Œé‚£ä¹ˆä¸ºäº†ä¿è¯è¾“å…¥è¾“å‡ºçš„ä¸€è‡´æ€§ï¼Œpytorch ä¹Ÿä¼šæŠŠ <code>output</code> æ‰“åŒ…æˆä¸€ä¸ª <code>PackedSequence</code> å¯¹è±¡ï¼Œæˆ‘ä»¬å°†ä¸Šé¢ä¾‹å­çš„æ•°æ®è¾“å…¥ <code>RNN</code> ï¼Œçœ‹çœ‹è¾“å‡ºæ˜¯ä»€ä¹ˆæ ·å­çš„ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># initialize</span></span><br><span class="line">h0 = Variable(torch.randn(n_layers, batch_size, hidden_size))</span><br><span class="line"><span class="comment"># forward</span></span><br><span class="line">out, _ = rnn(pack, h0)</span><br><span class="line">print(out)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>PackedSequence(data=tensor([[ <span class="number">-0.3207</span>, <span class="number">-0.4567</span>],</span><br><span class="line">        [ <span class="number">0.6665</span>,  <span class="number">0.0530</span>],</span><br><span class="line">        [ <span class="number">0.4456</span>,  <span class="number">0.1340</span>],</span><br><span class="line">        [ <span class="number">0.3373</span>, <span class="number">-0.3268</span>]]), batch_sizes=tensor([ <span class="number">2</span>,  <span class="number">1</span>,  <span class="number">1</span>]))</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºçš„ <code>PackedSequence</code> ä¸­åŒ…å«ä¸¤éƒ¨åˆ†ï¼Œå…¶ä¸­ <code>data</code> æ‰æ˜¯æˆ‘ä»¬è¦çš„ <code>output</code>ã€‚ä½†è¿™ä¸ª <code>output</code> çš„ shape å¹¶ä¸æ˜¯ <code>(seq_len, batch, num_directions * hidden_size)</code>ï¼Œå› ä¸º pytorch å·²ç»æŠŠè¾“å…¥æ•°æ®ä¸­é‚£äº›å¡«å……çš„ 0 å»æ‰äº†ï¼Œå› æ­¤è¾“å‡ºæ¥çš„æ•°æ®å¯¹åº”çš„æ˜¯çœŸå®çš„åºåˆ—é•¿åº¦ã€‚æˆ‘ä»¬è¦æŠŠå®ƒé‡æ–°å¡«å……å›ä¸€ä¸ªæ–¹æ–¹æ­£æ­£çš„ tensor æ‰æ–¹ä¾¿å¤„ç†ï¼Œè¿™é‡Œä¼šç”¨åˆ°å¦ä¸€ä¸ªç›¸åçš„æ“ä½œå‡½æ•° <code>torch.nn.utils.pad_packed_sequence</code>ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># unpack</span></span><br><span class="line">unpacked = pad_packed_sequence(out)</span><br><span class="line">out, bz = unpacked[<span class="number">0</span>], unpacked[<span class="number">1</span>]</span><br><span class="line">print(out, bz)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>tensor([[[ <span class="number">-0.3207</span>, <span class="number">-0.4567</span>],</span><br><span class="line">         [ <span class="number">0.6665</span>,  <span class="number">0.0530</span>]],</span><br><span class="line"></span><br><span class="line">        [[ <span class="number">0.4456</span>,  <span class="number">0.1340</span>],</span><br><span class="line">         [ <span class="number">0.0000</span>,  <span class="number">0.0000</span>]],</span><br><span class="line"></span><br><span class="line">        [[ <span class="number">0.3373</span>, <span class="number">-0.3268</span>],</span><br><span class="line">         [ <span class="number">0.0000</span>,  <span class="number">0.0000</span>]]]) tensor([ <span class="number">3</span>,  <span class="number">1</span>])</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨ï¼Œè¿™ä¸ª <code>output</code> çš„ shape å°±æ˜¯ä¸€ä¸ªæ ‡å‡†å½¢å¼äº†ã€‚</p>
<p>ä¸è¿‡æˆ‘ä¸€èˆ¬æ›´ä¹ æƒ¯ <code>batch_size</code> ä½œä¸ºç¬¬ä¸€ä¸ªç»´åº¦ï¼Œæ‰€ä»¥å¯ä»¥ç¨å¾®è°ƒæ•´ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># seq_len x batch_size x hidden_size --&gt; batch_size x seq_len x hidden_size</span></span><br><span class="line">out = out.permute((<span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>))</span><br><span class="line">print(<span class="string">"output"</span>, out)</span><br><span class="line">print(<span class="string">"input"</span>, order_x)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>output tensor([[[<span class="number">-0.1319</span>, <span class="number">-0.8469</span>],</span><br><span class="line">             [<span class="number">-0.3781</span>, <span class="number">-0.8940</span>],</span><br><span class="line">             [<span class="number">-0.4869</span>, <span class="number">-0.9621</span>]],</span><br><span class="line"></span><br><span class="line">            [[<span class="number">-0.8569</span>, <span class="number">-0.7509</span>],</span><br><span class="line">             [ <span class="number">0.0000</span>,  <span class="number">0.0000</span>],</span><br><span class="line">             [ <span class="number">0.0000</span>,  <span class="number">0.0000</span>]]])</span><br><span class="line">    intput tensor([[[ <span class="number">1.</span>],</span><br><span class="line">             [ <span class="number">2.</span>],</span><br><span class="line">             [ <span class="number">3.</span>]],</span><br><span class="line"></span><br><span class="line">            [[ <span class="number">1.</span>],</span><br><span class="line">             [ <span class="number">0.</span>],</span><br><span class="line">             [ <span class="number">0.</span>]]])</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨ï¼Œè¾“å…¥è¾“å‡ºå°±ä¸€ä¸€å¯¹åº”äº†ã€‚ä¹‹åï¼Œä½ å¯ä»¥ä» <code>output</code> ä¸­å–å‡ºä½ éœ€è¦çš„ hidden stateï¼Œç„¶åæ¥ä¸ªå…¨è¿æ¥å±‚ä¹‹ç±»çš„ï¼Œå¾—åˆ°çœŸæ­£æ„ä¹‰ä¸Šçš„ output vectorã€‚å–å‡º hidden state ä¸€èˆ¬ä¼šç”¨åˆ° <code>torch.gather</code> å‡½æ•°ï¼Œæ¯”å¦‚ï¼Œå¦‚æœæˆ‘æƒ³å–å‡ºæœ€åä¸€ä¸ªæ—¶é—´åºåˆ—çš„ hidden stateï¼Œå¯ä»¥è¿™æ ·å†™ (è¿™æ®µä»£ç å°±ä¸å¤šè§£é‡Šäº†ï¼Œè¯·æŸ¥ä¸€ä¸‹ <code>torch.gather</code> çš„ç”¨æ³•ï¼Œè‡ªè¡Œä½“ä¼š)ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bzæ¥è‡ªä¸Šé¢çš„ä¾‹å­, bz=tensor([ 3,  1])</span></span><br><span class="line">bz = (bz - <span class="number">1</span>).view(bz.shape[<span class="number">0</span>], <span class="number">1</span>, <span class="number">-1</span>)</span><br><span class="line">print(bz)</span><br><span class="line">bz = bz.repeat(<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">print(bz)</span><br><span class="line">out = torch.gather(out, <span class="number">1</span>, bz)</span><br><span class="line">print(out)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>tensor([[[<span class="number">2</span>]], [[<span class="number">0</span>]]])</span><br><span class="line">    tensor([[[<span class="number">2</span>, <span class="number">2</span>]], [<span class="number">0</span>, <span class="number">0</span>]])</span><br><span class="line">    tensor([[[<span class="number">-0.4869</span>, <span class="number">-0.9621</span>]],</span><br><span class="line"></span><br><span class="line">            [[<span class="number">-0.8569</span>, <span class="number">-0.7509</span>]]])</span><br></pre></td></tr></table></figure>
<p>å¯¹äº†ï¼Œæœ€åè¦æ³¨æ„ä¸€ç‚¹ï¼Œå› ä¸º <code>pack_padded_sequence</code> æŠŠè¾“å…¥æ•°æ®æŒ‰ç…§ <span class="math inline">\(seq\_len\)</span> ä»å¤§åˆ°å°é‡æ–°æ’åºäº†ï¼Œæ‰€ä»¥åé¢åœ¨è®¡ç®— loss çš„æ—¶å€™ï¼Œè¦ä¹ˆæŠŠ <code>output</code> çš„é¡ºåºé‡æ–°è°ƒæ•´å›å»ï¼Œè¦ä¹ˆæŠŠ target æ•°æ®çš„é¡ºåºä¹ŸæŒ‰ç…§æ–°çš„ <span class="math inline">\(seq\_len\)</span> é‡æ–°æ’åºã€‚å½“ target æ˜¯ label æ—¶ï¼Œè°ƒæ•´èµ·æ¥è¿˜ç®—æ–¹ä¾¿ï¼Œä½†å¦‚æœ target ä¹Ÿæ˜¯åºåˆ—ç±»å‹çš„æ•°æ®ï¼Œå¯èƒ½ä¼šå¤šç‚¹ä½“åŠ›æ´»ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡<a href="https://zhuanlan.zhihu.com/p/28472545" target="_blank" rel="noopener">æ–‡ç« </a>è¿›è¡Œè°ƒæ•´ã€‚</p>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li><a href="https://www.zhihu.com/question/52200883" target="_blank" rel="noopener">tensor flow dynamic_rnn ä¸rnnæœ‰å•¥åŒºåˆ«ï¼Ÿ</a></li>
<li><a href="https://pytorch.org/docs/stable/nn.html#torch.nn.RNN" target="_blank" rel="noopener">pytorchå®˜æ–¹æ–‡æ¡£</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/32103001" target="_blank" rel="noopener">è¯»PyTorchæºç å­¦ä¹ RNNï¼ˆ1ï¼‰</a></li>
<li><a href="https://stackoverflow.com/questions/51030782/why-do-we-pack-the-sequences-in-pytorch" target="_blank" rel="noopener">why do we â€œpackâ€ the sequences in pytorch?</a></li>
<li><a href="https://www.cnblogs.com/lindaxin/p/8052043.html" target="_blank" rel="noopener">pytorchå¯¹å¯å˜é•¿åº¦åºåˆ—çš„å¤„ç†</a></li>
<li><a href="https://karpathy.github.io/2015/05/21/rnn-effectiveness/" target="_blank" rel="noopener">The Unreasonable Effectiveness of Recurrent Neural Networks</a></li>
<li><a href="https://colah.github.io/posts/2015-08-Understanding-LSTMs/" target="_blank" rel="noopener">Understanding LSTM Networks</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/28472545" target="_blank" rel="noopener">pytorch RNN å˜é•¿è¾“å…¥ padding</a></li>
</ul>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <ul class="post-copyright">
    <li class="post-copyright-author">
      <strong>æœ¬æ–‡ä½œè€…ï¼š</strong>
      Jermmy
    </li>
    <li class="post-copyright-link">
      <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
      <a href="https://jermmy.github.io/2018/11/25/2018-11-25-how-to-write-rnn-in-pytorch-and-tensorflow/" title="RNNï¼Œå†™èµ·æ¥çœŸçš„çƒ¦">https://jermmy.github.io/2018/11/25/2018-11-25-how-to-write-rnn-in-pytorch-and-tensorflow/</a>
    </li>
    <li class="post-copyright-license">
      <strong>ç‰ˆæƒå£°æ˜ï¼š </strong>
      æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
    </li>
  </ul>


      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/æ·±åº¦å­¦ä¹ /" rel="tag"># æ·±åº¦å­¦ä¹ </a>
          
            <a href="/tags/pytorch/" rel="tag"># pytorch</a>
          
            <a href="/tags/tensorflow/" rel="tag"># tensorflow</a>
          
            <a href="/tags/nlp/" rel="tag"># nlp</a>
          
            <a href="/tags/rnn/" rel="tag"># rnn</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/10/03/2018-10-3-paper-note-learning-warped-guidance-for-blind-face-restoration/" rel="next" title="è®ºæ–‡ç¬”è®°ï¼šLearning warped guidance for blind face restoration">
                <i class="fa fa-chevron-left"></i> è®ºæ–‡ç¬”è®°ï¼šLearning warped guidance for blind face restoration
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/12/02/2018-12-2-one-day-in-guilin/" rel="prev" title="One Day in æ¡‚æ—">
                One Day in æ¡‚æ— <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="Jermmy" />
          <p class="site-author-name" itemprop="name">Jermmy</p>
           
              <p class="site-description motion-element" itemprop="description">In me the tiger sniffs the rose.</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">94</span>
                <span class="site-state-item-name">æ—¥å¿—</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">19</span>
                <span class="site-state-item-name">åˆ†ç±»</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">43</span>
                <span class="site-state-item-name">æ ‡ç­¾</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/jermmy" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.ruanyifeng.com/blog/" title="é˜®ä¸€å³°" target="_blank">é˜®ä¸€å³°</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://freemind.pluskid.org/" title="pluskid" target="_blank">pluskid</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#ä»€ä¹ˆæ˜¯-rnn"><span class="nav-number">1.</span> <span class="nav-text">ä»€ä¹ˆæ˜¯ RNN</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pytorch-ä¸­çš„-rnn"><span class="nav-number">2.</span> <span class="nav-text">pytorch ä¸­çš„ RNN</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#æ•°æ®å¤„ç†"><span class="nav-number">2.1.</span> <span class="nav-text">æ•°æ®å¤„ç†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ¨¡å‹æ­å»º"><span class="nav-number">2.2.</span> <span class="nav-text">æ¨¡å‹æ­å»º</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#rnn"><span class="nav-number">2.2.1.</span> <span class="nav-text">RNN</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pack_padded_sequence"><span class="nav-number">2.2.2.</span> <span class="nav-text">pack_padded_sequence</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rnnçš„è¾“å‡º"><span class="nav-number">2.2.3.</span> <span class="nav-text">RNNçš„è¾“å‡º</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å‚è€ƒ"><span class="nav-number">3.</span> <span class="nav-text">å‚è€ƒ</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jermmy</span>
</div>


<div class="powered-by">
  ç”± <a class="theme-link" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨
</div>

<div class="theme-info">
  ä¸»é¢˜ -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://jermmy.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://jermmy.github.io/2018/11/25/2018-11-25-how-to-write-rnn-in-pytorch-and-tensorflow/';
          this.page.identifier = '2018/11/25/2018-11-25-how-to-write-rnn-in-pytorch-and-tensorflow/';
          this.page.title = 'RNNï¼Œå†™èµ·æ¥çœŸçš„çƒ¦';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://jermmy.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  





  








  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("FfkJQoNEh55mO6eDSUYJj0i1-gzGzoHsz", "sjxRrTn3UCxYsAQceJKYEfO7");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
